<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple AR Controller Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        #ui {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        
        #log {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h2>Simple AR Controller Test</h2>
        <p id="status">Ready</p>
        <button id="startAR">Start Simple AR</button>
        <button id="addCube">Add Test Cube</button>
        <button id="clearAll">Clear All</button>
    </div>
    
    <div id="log">
        <div>Debug Log:</div>
    </div>

    <script>
        let scene, camera, renderer, session, referenceSpace;
        let controllers = [];
        let cubes = [];
        let logDiv = document.getElementById('log');
        
        function log(message) {
            console.log(message);
            logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            log('STATUS: ' + message);
        }
        
        function init() {
            // Create scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // Add lighting
            const light = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(light);
            
            const directional = new THREE.DirectionalLight(0xffffff, 0.5);
            directional.position.set(1, 1, 1);
            scene.add(directional);
            
            log('Three.js initialized');
        }
        
        function createController(index) {
            const controller = renderer.xr.getController(index);
            
            // Add select event
            controller.addEventListener('selectstart', () => {
                log(`Controller ${index} trigger pressed!`);
                addCubeAtController(controller);
            });
            
            // Create visual ray
            const geometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(0, 0, -2)
            ]);
            const material = new THREE.LineBasicMaterial({ color: 0xff0000 });
            const line = new THREE.Line(geometry, material);
            controller.add(line);
            
            scene.add(controller);
            controllers.push(controller);
            
            log(`Controller ${index} created`);
            return controller;
        }
        
        function addCubeAtController(controller) {
            // Get controller position
            const position = new THREE.Vector3();
            controller.getWorldPosition(position);
            
            // Move cube forward from controller
            const direction = new THREE.Vector3(0, 0, -1);
            const matrix = new THREE.Matrix4();
            matrix.extractRotation(controller.matrixWorld);
            direction.applyMatrix4(matrix);
            
            position.add(direction.multiplyScalar(0.5)); // 0.5 meters forward
            
            addCube(position);
        }
        
        function addCube(position) {
            const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
            const material = new THREE.MeshPhongMaterial({ 
                color: Math.random() * 0xffffff 
            });
            const cube = new THREE.Mesh(geometry, material);
            
            if (position) {
                cube.position.copy(position);
            } else {
                cube.position.set(0, 1.5, -1); // Default position
            }
            
            scene.add(cube);
            cubes.push(cube);
            
            log(`Cube added at: ${cube.position.x.toFixed(2)}, ${cube.position.y.toFixed(2)}, ${cube.position.z.toFixed(2)}`);
        }
        
        function clearAll() {
            cubes.forEach(cube => {
                scene.remove(cube);
            });
            cubes = [];
            log('All cubes cleared');
        }
        
        async function startAR() {
            const button = document.getElementById('startAR');
            button.disabled = true;
            button.textContent = 'Starting...';
            
            try {
                log('Requesting AR session...');
                session = await navigator.xr.requestSession('immersive-ar');
                log('✓ Got AR session');
                
                // Get reference space
                referenceSpace = await session.requestReferenceSpace('local');
                log('✓ Got reference space');
                
                // Set up session
                await renderer.xr.setSession(session);
                log('✓ Three.js XR session set');
                
                // Create controllers
                createController(0);
                createController(1);
                
                // Start render loop
                renderer.setAnimationLoop(render);
                log('✓ Render loop started');
                
                // Handle session end
                session.addEventListener('end', () => {
                    log('AR session ended');
                    session = null;
                    controllers = [];
                    renderer.setAnimationLoop(null);
                    button.textContent = 'Start Simple AR';
                    button.disabled = false;
                    updateStatus('AR session ended');
                });
                
                updateStatus('AR Active! Pull controller triggers to add cubes');
                button.textContent = 'Exit AR';
                button.onclick = () => session.end();
                
            } catch (error) {
                log(`❌ AR failed: ${error.message}`);
                updateStatus(`AR failed: ${error.message}`);
                button.textContent = 'Start Simple AR';
                button.disabled = false;
            }
        }
        
        function render() {
            renderer.render(scene, camera);
        }
        
        // Initialize
        init();
        
        // Button events
        document.getElementById('startAR').onclick = startAR;
        document.getElementById('addCube').onclick = () => addCube();
        document.getElementById('clearAll').onclick = clearAll;
        
        updateStatus('Ready - Click Start Simple AR');
    </script>
</body>
</html>
